<!-- 
    =======================================================================================
    H·ªÜ TH·ªêNG T√ÅC NGHI·ªÜP ƒê·ªòNG (FINAL PRO) - DATA-DRIVEN ENVIRONMENT
    T√çCH H·ª¢P FIRESTORE CHO D·ªÆ LI·ªÜU ƒê·ªòNG V√Ä T·ªêI ∆ØU NGHI·ªÜP V·ª§ PH√íNG KTXH V√Ä VƒÇN PH√íNG UBND
    =======================================================================================
-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng T√°c Nghi·ªáp Chuy√™n S√¢u</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937; 
            background-color: #f5f7fa; 
            background-image: linear-gradient(to bottom, #f5f7fa 0%, #ffffff 20%); 
            background-attachment: fixed;
            scroll-behavior: smooth;
        }
        /*  */

        /* BANNER CH√çNH */
        .header-soft-glow {
            animation: color-shift 20s ease infinite;
            background: linear-gradient(135deg, #1D4ED8, #7C3AED, #DB2777, #06B6D4); 
            background-size: 400% 400%;
            box-shadow: 0 8px 20px rgba(29, 78, 216, 0.4);
        }
        @keyframes color-shift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        
        /* BANNER K·∫æ HO·∫†CH */
        #data-cleaning-banner {
            animation: plan-color-shift 10s ease infinite;
            background: linear-gradient(90deg, #F97316, #EF4444, #8B5CF6);
            background-size: 300% 100%;
        }
        @keyframes plan-color-shift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        /* TI√äU ƒê·ªÄ C·ªê ƒê·ªäNH */
        #sticky-header {
            position: sticky; top: 0; z-index: 50; background-color: #1d4ed8; color: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        
        /* N√öT TTHC */
        .tthc-button {
            height: 80px; transition: all 0.2s; word-break: break-word; white-space: normal;
            background-color: #f8fafc; border: 1px solid #d1d5db; color: #1f2937;
        }
        .tthc-button.selected {
            background-color: #1D4ED8; color: white; font-weight: 700; box-shadow: 0 4px 10px rgba(29, 78, 216, 0.6);
        }
        
        /* KHUNG PROMPT */
        #generated-prompt-output {
            background-color: #f9fafb; border: 1px dashed #9ca3af; cursor: pointer; 
        }

        /* N√∫t K·∫æT N·ªêI MINI AI */
        .notebook-button {
            background-color: #4F46E5; color: white; font-weight: 700;
        }
    </style>
</head>
<body class="p-4 md:p-12">

    <!-- BANNER TOP -->
    <header class="header-soft-glow rounded-xl mb-6 text-center">
        <h1 class="text-4xl font-extrabold title-soft-glow text-white tracking-wider">
            B·ªò C√îNG C·ª§ T√ÅC NGHI·ªÜP TTHC ƒê·∫§T ƒêAI C·∫§P X√É
        </h1>
        <p class="text-sm mt-2 text-white/90">
            N·ªôi dung ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n c·∫•u tr√∫c d·ªØ li·ªáu v√† H·ªá th·ªëng AI Suy lu·∫≠n Ph√°p l√Ω c·ªßa ƒê·ª©c Anh
        </p>
    </header>

    <!-- BANNER K·∫æ HO·∫†CH M·ªöI -->
    <a href="https://chatgpt.com/share/68f0f670-d124-800b-b5dc-dc6284c57cdf" target="_blank" class="w-full block mb-10">
        <div id="data-cleaning-banner" class="text-white text-center py-4 px-6 rounded-xl text-xl md:text-2xl tracking-wide">
            K·∫ø ho·∫°ch l√†m s·∫°ch D·ªØ li·ªáu ƒë·∫•t ƒëai (90 Ng√†y)
        </div>
    </a>


    <!-- TI√äU ƒê·ªÄ CU·ªòN C·ªê ƒê·ªäNH -->
    <div id="sticky-header" class="hidden">
        <p class="text-sm font-semibold">
            N·ªôi dung ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n c·∫•u tr√∫c d·ªØ li·ªáu v√† H·ªá th·ªëng AI Suy lu·∫≠n Ph√°p l√Ω c·ªßa ƒê·ª©c Anh (ducanh.bkcit) x√¢y d·ª±ng v√† ho√†n thi·ªán
        </p>
    </div>

    <!-- CONTAINER CH√çNH -->
    <div class="max-w-7xl mx-auto space-y-10">

        <!-- B∆Ø·ªöC 1: CH·ªåN TTHC -->
        <div class="custom-card p-8 rounded-xl">
            <h2 class="text-2xl font-bold mb-5 text-center text-gray-700">
                B∆∞·ªõc 1: Ch·ªçn Th·ªß t·ª•c H√†nh ch√≠nh (Context Ph√°p l√Ω)
            </h2>
            <div id="loading-tthc" class="text-center text-gray-500">ƒêang t·∫£i danh m·ª•c TTHC t·ª´ c∆° s·ªü d·ªØ li·ªáu...</div>
            <div id="tthc-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                <!-- D·ªØ li·ªáu TTHC ƒë∆∞·ª£c ch√®n b·∫±ng JS t·ª´ Firestore -->
            </div>
        </div>

        <!-- B∆Ø·ªöC 2: CH·ªåN H√ÄNH ƒê·ªòNG CH·ª®C NƒÇNG (B·ªï sung nghi·ªáp v·ª• VƒÉn ph√≤ng & KTXH) -->
        <div class="custom-card p-8 rounded-xl">
            <h2 class="text-2xl font-bold mb-5 text-center text-gray-700">
                B∆∞·ªõc 2: Ch·ªçn H√†nh ƒë·ªông Ch·ª©c nƒÉng (Lo·∫°i T√†i li·ªáu/Ph√¢n t√≠ch)
            </h2>

            <div id="action-list" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
                <button data-action="Tr√¨nh t·ª± Th·ªß t·ª•c" class="func-button bg-blue-500 text-white py-3 px-2 rounded-lg" onclick="selectAction('Tr√¨nh t·ª± Th·ªß t·ª•c')">Tr√¨nh t·ª± Th·ªß t·ª•c</button>
                <button data-action="H·ªì s∆°, Gi·∫•y t·ªù" class="func-button bg-cyan-500 text-white py-3 px-2 rounded-lg" onclick="selectAction('H·ªì s∆°, Gi·∫•y t·ªù')">H·ªì s∆°, Gi·∫•y t·ªù</button>
                <button data-action="C√¥ng vƒÉn" class="func-button bg-green-500 text-white py-3 px-2 rounded-lg" onclick="selectAction('C√¥ng vƒÉn')">C√¥ng vƒÉn</button>
                <button data-action="T·ªù tr√¨nh" class="func-button bg-yellow-500 text-gray-800 py-3 px-2 rounded-lg" onclick="selectAction('T·ªù tr√¨nh')">T·ªù tr√¨nh</button>
                <button data-action="B√°o c√°o" class="func-button bg-red-500 text-white py-3 px-2 rounded-lg" onclick="selectAction('B√°o c√°o')">B√°o c√°o</button>
                <button data-action="D·ª± th·∫£o Quy·∫øt ƒë·ªãnh" class="func-button bg-purple-500 text-white py-3 px-2 rounded-lg" onclick="selectAction('D·ª± th·∫£o Quy·∫øt ƒë·ªãnh')">D·ª± th·∫£o Quy·∫øt ƒë·ªãnh</button>
                <button data-action="R√† so√°t Ph√°p l√Ω" class="func-button bg-gray-600 text-white py-3 px-2 rounded-lg" onclick="selectAction('R√† so√°t Ph√°p l√Ω')">R√† so√°t Ph√°p l√Ω</button>
            </div>
        </div>

        <!-- B∆Ø·ªöC 3: NH·∫¨P Y√äU C·∫¶U T√ôY BI·∫æN -->
        <div class="custom-card p-8 rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-700">
                B∆∞·ªõc 3: Nh·∫≠p Y√™u c·∫ßu T√πy bi·∫øn (Chi ti·∫øt c√¥ng vi·ªác)
            </h2>
            
            <textarea id="user-query-input" rows="2" placeholder="NH·∫¨P Y√äU C·∫¶U C√îNG VI·ªÜC... (V√≠ d·ª•: ƒê·ªÅ xu·∫•t tr√¨nh k√Ω g·∫•p, l∆∞u tr·ªØ b·∫£n nh√°p tr√™n Google Drive c√° nh√¢n, v√† g·ª≠i email ph·∫£n h·ªìi cho ng∆∞·ªùi d√¢n.)"
                      class="w-full p-4 text-base bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500 resize-none shadow-inner"></textarea>
            
            <div class="mt-5 flex justify-center space-x-4">
                <button id="execute-button" 
                        class="execute-button text-white font-bold py-3 px-8 rounded-lg text-lg flex items-center justify-center disabled:opacity-50"
                        onclick="this.classList.add('clicked'); setTimeout(() => this.classList.remove('clicked'), 1000);"
                >
                    <span id="button-text">X√ÇY D·ª∞NG C√ÇU L·ªÜNH</span>
                    <div id="loading-spinner" class="spinner ml-3 hidden"></div>
                </button>

                <!-- N√öT H√ÄNH ƒê·ªòNG ƒê√ìNG G√ìI -->
                <button id="action-button-notebooklm" 
                        class="notebook-button py-3 px-6 rounded-lg text-lg flex items-center" 
                        onclick="packageAndExecute()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zm14 0a1 1 0 110 2h-6a1 1 0 110-2h6z" clip-rule="evenodd" />
                    </svg>
                    K·∫æT N·ªêI MINI AI DUCANH.BKCIT
                </button>
            </div>

            <!-- TH√äM FILE D·ªÆ LI·ªÜU NGU·ªíN -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-bold text-gray-600 mb-3 text-center">
                    T√≠ch h·ª£p D·ªØ li·ªáu Ngu·ªìn Chuy√™n s√¢u
                </h3>
                <div class="mt-4 flex flex-wrap justify-center gap-4">
                    <button id="btnAddFile" class="notebook-button bg-green-600 hover:bg-green-700 py-2 px-6 rounded-lg text-base flex items-center" onclick="alert('M√¥ ph·ªèng: T√≠nh nƒÉng n√†y y√™u c·∫ßu m√¥i tr∆∞·ªùng Backend ƒë·ªÉ m·ªü Drive Picker. Trong m√¥i tr∆∞·ªùng th·ª±c t·∫ø, Anh s·∫Ω ch·ªçn file t·ª´ Google Drive ƒë·ªÉ b·ªï sung ngu·ªìn cho NotebookLM.')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5.5 10a.5.5 0 01.5-.5h4a.5.5 0 010 1H6a.5.5 0 01-.5-.5z" />
                            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm2 1h4V3H5v1zm1 7a1 1 0 011-1h5a1 1 0 011 1v5a1 1 0 01-1 1H7a1 1 0 01-1-1v-5zm2 1h4v4H8v-4z" clip-rule="evenodd" />
                        </svg>
                        TH√äM FILE D·ªÆ LI·ªÜU NGU·ªíN
                    </button>
                </div>
            </div>
        </div>
        
        <!-- KHUNG K·∫æT QU·∫¢ PROMPT T·ªêI ∆ØU (ƒê·ªòNG) -->
        <div class="custom-card p-8 rounded-xl">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-2xl font-bold text-gray-700">
                    C√¢u l·ªánh ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a:
                    <span id="selected-tthc-name" class="text-blue-600 font-extrabold ml-2"></span>
                </h2>
                <button id="copy-button" class="bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-200 transition duration-150 ease-in-out hidden" onclick="copyPromptToClipboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4-4m0 0l-4 4m4-4V3" />
                    </svg>
                    <span id="copy-text">COPY C√ÇU L·ªÜNH T·ªêI ∆ØU</span>
                </button>
            </div>
            
            <div id="result-container">
                <!-- Th√™m id cho div wrapper ƒë·ªÉ b√¥i ƒëen -->
                <div id="generated-prompt-output" 
                     class="text-gray-700 whitespace-pre-wrap text-sm max-h-[36rem] overflow-hidden shadow-inner cursor-pointer"
                     onclick="selectText(this.id)">
                    <p class="text-center text-gray-500 italic">
                        Vui l√≤ng ho√†n th√†nh ƒë·ªß 3 b∆∞·ªõc ƒë·ªÉ **X√ÇY D·ª∞NG C√ÇU L·ªÜNH** chuy√™n s√¢u...
                    </p>
                </div>
                <div id="data-status" class="mt-4 text-xs text-center text-red-600"></div>
            </div>
        </div>

    </div>

    <!-- MINI-CHECKLIST CU·ªêI TRANG -->
    <div class="max-w-7xl mx-auto mt-12 pt-6 border-t border-gray-300">
        <h3 class="text-xl font-bold text-red-600 mb-4">üìå Mini-checklist T·ª± ki·ªÉm tra Prompt</h3>
        <ul class="space-y-3 text-sm text-gray-700 list-disc list-inside">
            <li class="p-3 bg-white border border-gray-200 rounded-md shadow-sm flex items-start">
                <span class="text-green-600 font-extrabold mr-2">‚úÖ</span> 
                **Tr√≠ch d·∫´n ƒë·ªß ƒêi·ªÅu/Kho·∫£n/ƒêi·ªÉm?** (Y√™u c·∫ßu AI ph·∫£i n√™u r√µ)
            </li>
            <li class="p-3 bg-white border border-gray-200 rounded-md shadow-sm flex items-start">
                <span class="text-green-600 font-extrabold mr-2">‚úÖ</span> 
                **Chu·∫©n th·ªÉ th·ª©c Nƒê30/2020?** (Y√™u c·∫ßu AI √°p d·ª•ng)
            </li>
            <li class="p-3 bg-white border border-gray-200 rounded-md shadow-sm flex items-start">
                <span class="text-green-600 font-extrabold mr-2">‚úÖ</span> 
                **∆Øu ti√™n VB m·ªõi nh·∫•t (ghi r√µ VB thay th·∫ø)?** (C∆° ch·∫ø Suy lu·∫≠n Ph√°p l√Ω ƒë√£ t√≠ch h·ª£p)
            </li>
            <li class="p-3 bg-white border border-gray-200 rounded-md shadow-sm flex items-start">
                <span class="text-green-600 font-extrabold mr-2">‚úÖ</span> 
                **C√≥ checklist tr√≠ch d·∫´n + t√≥m t·∫Øt ph√°p l√Ω?** (Y√™u c·∫ßu ƒë·ªãnh d·∫°ng ƒë·∫ßu ra)
            </li>
            <li class="p-3 bg-red-100 border border-red-300 rounded-md shadow-sm text-red-700 font-bold flex items-start">
                <span class="text-red-700 font-extrabold mr-2">‚ö†Ô∏è</span> 
                **ƒê·∫£m b·∫£o d·ªØ li·ªáu an to√†n th√¥ng tin m·∫°ng v√† Quy ƒë·ªãnh v·ªÅ d·ªØ li·ªáu "M·∫≠t"?** (Ki·ªÉm tra l·∫°i n·ªôi dung tr∆∞·ªõc khi d√°n v√†o AI)
            </li>
        </ul>
        <p class="mt-8 text-sm text-gray-500 text-center">
            Product by ducanh.bkcit<br>
            0901951525
        </p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let tthcData = [];

        const NOTEBOOK_ID = '5cdbc2b5-c953-4d2c-a8f9-3676e0d55dfc'; 
        const NOTEBOOK_URL = `https://notebooklm.google.com/notebook/${NOTEBOOK_ID}`;
        
        let lastGeneratedRawPrompt = "";
        let selectedTthc = "";
        let selectedAction = "";

        // Ngu·ªìn tri th·ª©c b·ªï sung (NG·∫¶M HI·ªÇU)
        const newKnowledgeSources = [
            "https://docs.google.com/document/d/1GXxouhNvUonOyQ-QuJUJkxjn-rQ_ec3OvMZL19Xc868/edit",
            "https://docs.google.com/document/d/1O8NdQF1ztMC5yVYak3rWCbYIvlSj4m85gr1jTfxF6Xc/edit"
        ];
        
        const primaryLegalTags = `
        **QUY T·∫ÆC PH√ÅP L√ù**: ∆ØU TI√äN S·ª¨ D·ª§NG VƒÇN B·∫¢N H·ª¢P NH·∫§T (Nƒê 151 v√† Nƒê 226/2025/Nƒê-CP). √Åp d·ª•ng c√°c Th√¥ng t∆∞ m·ªõi c·ªßa B·ªô X√¢y d·ª±ng (10/2025), B·ªô NNNMT (19/2025), B·ªô C√¥ng Th∆∞∆°ng (37/2025) v√† Lu·∫≠t TCCQƒêP 72/2025/QH15. N·∫øu c√≥ m√¢u thu·∫´n, √°p d·ª•ng Lu·∫≠t chuy√™n ng√†nh (Lu·∫≠t ƒê·∫•t ƒëai 2024). KH√îNG s·ª≠ d·ª•ng ho·∫∑c tr√≠ch d·∫´n d·ªØ li·ªáu M·∫≠t.
        `;

        // 7 PROMPT CH·ª®C NƒÇNG C·ªêT L√ïI (ƒê√£ t√≠ch h·ª£p Logic KTXH v√† VPUBND)
        const functionalPrompts = {
            "Tr√¨nh t·ª± Th·ªß t·ª•c": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£, ƒëang c·∫ßn r√† so√°t quy tr√¨nh ƒë·ªÉ h∆∞·ªõng d·∫´n ng∆∞·ªùi d√¢n cho th·ªß t·ª•c [${yeuCau.trim()}].
# (Y√äU C·∫¶U): H√£y tr√¨nh b√†y t·ªïng quan v√† chi ti·∫øt **Tr√¨nh t·ª± Th·ªß t·ª•c** th·ª±c hi·ªán theo vƒÉn b·∫£n h·ª£p nh·∫•t.
# (C√ÅC B∆Ø·ªöC): 1. X√°c ƒë·ªãnh ƒë√∫ng th·ªß t·ª•c. 2. Li·ªát k√™ c√°c b∆∞·ªõc th·ª±c hi·ªán tu·∫ßn t·ª±. 3. V·ªõi m·ªói b∆∞·ªõc, n√™u r√µ c∆° quan ch·ªß tr√¨, c∆° quan ph·ªëi h·ª£p, v√† k·∫øt qu·∫£ ƒë·∫ßu ra.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t **S∆° ƒë·ªì quy tr√¨nh** (d·∫°ng vƒÉn b·∫£n) v√† **Checklist c√°c m·ªëc th·ªùi gian**. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†N & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
            "H·ªì s∆°, Gi·∫•y t·ªù": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£, ƒëang c·∫ßn chu·∫©n b·ªã b·ªô h·ªì s∆° ho√†n ch·ªânh cho th·ªß t·ª•c [${yeuCau.trim()}].
# (Y√äU C·∫¶U): H√£y li·ªát k√™ chi ti·∫øt **H·ªì s∆°, Gi·∫•y t·ªù** c·∫ßn thi·∫øt ƒë·ªÉ n·ªôp. L∆∞u √Ω c√°c gi·∫•y t·ªù c·∫ßn ƒë∆∞·ª£c **c√¥ng ch·ª©ng/ch·ª©ng th·ª±c** (n·∫øu c√≥).
# (C√ÅC B∆Ø·ªöC): 1. X√°c ƒë·ªãnh th√†nh ph·∫ßn h·ªì s∆° theo Ngh·ªã ƒë·ªãnh 226/2025/Nƒê-CP. 2. Ph√¢n lo·∫°i gi·∫•y t·ªù: b·∫Øt bu·ªôc, thay th·∫ø (n·∫øu c√≥), v√† gi·∫•y t·ªù ph·∫£i c√¥ng ch·ª©ng.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t **B·∫£ng k√™ H·ªì s∆°** d∆∞·ªõi d·∫°ng Checklist, c√≥ ghi ch√∫ r√µ r√†ng v·ªÅ c√°c **Bi·ªÉu M·∫´u** c·∫ßn ƒëi·ªÅn. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†T & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
            "C√¥ng vƒÉn": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£/VƒÉn ph√≤ng UBND x√£, ƒëang so·∫°n C√¥ng vƒÉn g·∫•p.
# (Y√äU C·∫¶U): So·∫°n C√¥ng vƒÉn [Tr√≠ch y·∫øu: ${yeuCau.trim()}] g·ª≠i [ƒê∆°n v·ªã/C·∫•p c√≥ th·∫©m quy·ªÅn]. N·ªôi dung ph·∫£i ch·ª©a th√¥ng tin ƒë∆∞·ª£c cung c·∫•p trong y√™u c·∫ßu.
# (C√ÅC B∆Ø·ªöC): 1. Ph√¢n t√≠ch y√™u c·∫ßu v√† x√°c ƒë·ªãnh cƒÉn c·ª© ph√°p l√Ω li√™n quan. 2. So·∫°n n·ªôi dung theo c·∫•u tr√∫c h√†nh ch√≠nh. 3. Th√™m b·∫£ng cƒÉn c·ª© ph√°p l√Ω.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t C√¥ng vƒÉn chu·∫©n **Ngh·ªã ƒë·ªãnh 30/2020/Nƒê-CP** (v·ªÅ th·ªÉ th·ª©c) + B·∫£ng cƒÉn c·ª© chi ti·∫øt + **Checklist Ph√°p l√Ω**. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†N & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
            "T·ªù tr√¨nh": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£/VƒÉn ph√≤ng UBND x√£, ƒëang l·∫≠p T·ªù tr√¨nh ƒë·ªÉ tr√¨nh c·∫•p tr√™n.
# (Y√äU C·∫¶U): So·∫°n T·ªù tr√¨nh v·ªÅ [N·ªôi dung: ${yeuCau.trim()}]. Tr√¨nh [UBND c·∫•p x√£/huy·ªán]. T·ªù tr√¨nh ph·∫£i ch·ª©a th√¥ng tin ƒë∆∞·ª£c cung c·∫•p trong y√™u c·∫ßu.
# (C√ÅC B∆Ø·ªöC): 1. X√°c ƒë·ªãnh th·∫©m quy·ªÅn gi·∫£i quy·∫øt. 2. Tra c·ª©u cƒÉn c·ª© ph√°p l√Ω m·ªõi nh·∫•t. 3. X√¢y d·ª±ng T·ªù tr√¨nh theo th·ªÉ th·ª©c h√†nh ch√≠nh, t·∫≠p trung v√†o t√≠nh thuy·∫øt ph·ª•c.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t T·ªù tr√¨nh chu·∫©n **Ngh·ªã ƒë·ªãnh 30/2020/Nƒê-CP** + Checklist c√°c ƒëi·ªÉm c·∫ßn ƒëi·ªÅn chi ti·∫øt. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†N & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
            "B√°o c√°o": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£/VƒÉn ph√≤ng UBND x√£, ƒëang so·∫°n B√°o c√°o ƒë·ªãnh k·ª≥/ƒë·ªôt xu·∫•t.
# (Y√äU C·∫¶U): So·∫°n B√°o c√°o v·ªÅ [Ti·∫øn ƒë·ªô/Kinh t·∫ø-X√£ h·ªôi]: ${yeuCau.trim()}. N·ªôi dung B√°o c√°o ph·∫£i ph·∫£n √°nh t√¨nh h√¨nh gi·∫£i quy·∫øt c√¥ng vi·ªác.
# (C√ÅC B∆Ø·ªöC): 1. X√°c ƒë·ªãnh c√°c ch·ªâ ti√™u li√™n quan. 2. Tr√≠ch ƒë√∫ng ƒêi·ªÅu/Kho·∫£n/ƒêi·ªÉm t·ª´ VB m·ªõi nh·∫•t. 3. ƒê·ªÅ xu·∫•t gi·∫£i ph√°p.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t B√°o c√°o chu·∫©n th·ªÉ th·ª©c h√†nh ch√≠nh, k√®m theo **B·∫£ng t·ªïng h·ª£p s·ªë li·ªáu** v√† **Danh m·ª•c V∆∞·ªõng m·∫Øc/Ki·∫øn ngh·ªã** c√≥ tr√≠ch d·∫´n ph√°p l√Ω. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†N & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
            "D·ª± th·∫£o Quy·∫øt ƒë·ªãnh": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£/VƒÉn ph√≤ng UBND x√£, ƒëang l·∫≠p D·ª± th·∫£o Quy·∫øt ƒë·ªãnh ƒë·ªÉ tr√¨nh Ch·ªß t·ªãch UBND x√£.
# (Y√äU C·∫¶U): L·∫≠p D·ª± th·∫£o Quy·∫øt ƒë·ªãnh v·ªÅ [N·ªôi dung: ${yeuCau.trim()}]. Quy·∫øt ƒë·ªãnh ph·∫£i c√≥ ƒë·∫ßy ƒë·ªß c√°c y·∫øu t·ªë: CƒÉn c·ª© ph√°p l√Ω, X√©t ƒë·ªÅ ngh·ªã, Quy·∫øt ƒë·ªãnh v√† ƒêi·ªÅu kho·∫£n thi h√†nh.
# (C√ÅC B∆Ø·ªöC): 1. X√°c ƒë·ªãnh ƒë√∫ng th·∫©m quy·ªÅn ban h√†nh Quy·∫øt ƒë·ªãnh (theo Nƒê 151/226). 2. X√¢y d·ª±ng CƒÉn c·ª© Ph√°p l√Ω (Lu·∫≠t ƒê·∫•t ƒëai 2024, Nƒê h·ª£p nh·∫•t, Qƒê 58/2024/Qƒê-UBND t·ªânh ƒê·ªìng Nai...). 3. So·∫°n th·∫£o c√°c ƒêi·ªÅu kho·∫£n c·ª• th·ªÉ.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t D·ª± th·∫£o Quy·∫øt ƒë·ªãnh chu·∫©n **Ngh·ªã ƒë·ªãnh 30/2020/Nƒê-CP** + **B·∫£ng Ki·ªÉm tra Ngu·ªìn Ph√°p l√Ω** ƒë·ªÉ t√¥i th·∫©m ƒë·ªãnh. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†N & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
            "R√† so√°t Ph√°p l√Ω": (yeuCau, m4Action) => `
# (VAI TR√í): T√¥i, Chuy√™n vi√™n Ph√≤ng Kinh t·∫ø x√£/VƒÉn ph√≤ng UBND x√£, ƒëang th·ª±c hi·ªán r√† so√°t ph√°p l√Ω chuy√™n s√¢u.
# (Y√äU C·∫¶U): Th·ª±c hi·ªán R√† so√°t ph√°p l√Ω cho [VƒÉn b·∫£n/H·ªì s∆°/Y√™u c·∫ßu: ${yeuCau.trim()}].
# (C√ÅC B∆Ø·ªöC): 1. Ph√¢n t√≠ch n·ªôi dung v√† ƒë·ªëi chi·∫øu t·ª´ng ƒëi·ªÅu kho·∫£n v·ªõi Lu·∫≠t ƒê·∫•t ƒëai 2024 v√† **VƒÇN B·∫¢N H·ª¢P NH·∫§T Nƒê 151 v√† Nƒê 226/2025/Nƒê-CP**. 2. Ki·ªÉm tra t√≠nh hi·ªáu l·ª±c c·ªßa t·ª´ng cƒÉn c·ª© ph√°p l√Ω ƒë∆∞·ª£c tr√≠ch d·∫´n. 3. ƒê·ªÅ xu·∫•t h√†nh ƒë·ªông.
# (M·ª§C TI√äU CU·ªêI C√ôNG): Xu·∫•t: (A) **B·∫£ng Ki·ªÉm Ph√°p L√Ω**. (B) **ƒê·ªÅ xu·∫•t s·ª≠a ƒë·ªïi chi ti·∫øt**. (C) N·∫øu v∆∞·ª£t th·∫©m quy·ªÅn ‚Üí ghi r√µ **‚ÄúCHUY·ªÇN PH√íNG PH√ÅP CH·∫æ‚Äù**. B·∫Øt bu·ªôc th·ª±c hi·ªán **${m4Action}** sau khi so·∫°n th·∫£o.
# (GI·ªöI H·∫†N & R√ÄNG BU·ªòC): ${primaryLegalTags}
`,
        };
        
        // FIREBASE INITIALIZATION AND DATA FETCHING
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in anonymously if no token is available, otherwise use custom token (for Canvas)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || 'anonymous';
                
                fetchTthcData();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('data-status').textContent = '‚ö†Ô∏è L·ªói k·∫øt n·ªëi CSDL (Firestore). D·ªØ li·ªáu tƒ©nh s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.';
                useStaticDataFallback();
            }
        }

        function fetchTthcData() {
            const tthcCollectionPath = `/artifacts/${appId}/public/data/tthc_list`;
            const q = query(collection(db, tthcCollectionPath));

            document.getElementById('loading-tthc').textContent = 'ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu TTHC...';
            
            onSnapshot(q, (snapshot) => {
                tthcData = [];
                snapshot.forEach((doc) => {
                    tthcData.push(doc.data());
                });

                if (tthcData.length === 0) {
                     document.getElementById('loading-tthc').textContent = '‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu TTHC trong CSDL. Vui l√≤ng th√™m d·ªØ li·ªáu.';
                } else {
                     document.getElementById('loading-tthc').textContent = `ƒê√£ ƒë·ªìng b·ªô ${tthcData.length} th·ªß t·ª•c h√†nh ch√≠nh.`;
                }
                renderTthcList();
            }, (error) => {
                console.error("L·ªói ƒë·ªìng b·ªô Firestore:", error);
                document.getElementById('data-status').textContent = '‚ö†Ô∏è L·ªói ƒë·ªìng b·ªô Firestore. D·ªØ li·ªáu tƒ©nh s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.';
                useStaticDataFallback();
            });
        }
        
        // STATIC FALLBACK DATA (For local running or connection error)
        function useStaticDataFallback() {
             const staticList = [
                "1.013949 - Giao ƒë·∫•t, cho thu√™ ƒë·∫•t, chuy·ªÉn m·ª•c ƒë√≠ch s·ª≠ d·ª•ng ƒë·∫•t",
                "1.012819 - B·ªìi th∆∞·ªùng, h·ªó tr·ª£ khi Nh√† n∆∞·ªõc thu h·ªìi ƒë·∫•t",
                "1.013959 - ƒêƒÉng k√Ω bi·∫øn ƒë·ªông do thay ƒë·ªïi th√¥ng tin",
                "1.013975 - H√≤a gi·∫£i tranh ch·∫•p ƒë·∫•t ƒëai t·∫°i UBND c·∫•p x√£",
                "1.012821 - T·∫∑ng cho QSDƒê v√¨ m·ª•c ƒë√≠ch giao th√¥ng, c√¥ng c·ªông",
            ];
             tthcData = staticList.map(item => {
                const [maSo, tenThuTuc] = item.split(" - ");
                return { maSo, tenThuTuc };
            });
            renderTthcList();
        }

        function determineM4Action(query) {
            const lowerQuery = query.toLowerCase();
            let action = "ki·ªÉm tra l·∫°i n·ªôi dung";

            if (lowerQuery.includes('google drive') || lowerQuery.includes('drive')) { action = "L∆∞u tr·ªØ b·∫£n nh√°p tr√™n Google Drive c√° nh√¢n"; } 
            else if (lowerQuery.includes('google docs') || lowerQuery.includes('docs') || lowerQuery.includes('ƒë·ªìng b·ªô')) { action = "L∆∞u tr·ªØ b·∫£n nh√°p tr√™n Docs ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªìng b·ªô v·ªõi ƒë·ªìng nghi·ªáp"; } 
            else if (lowerQuery.includes('tr√¨nh k√Ω')) { action = "Chu·∫©n b·ªã ƒë·ªÉ tr√¨nh k√Ω ngay l·∫≠p t·ª©c"; } 
            else if (lowerQuery.includes('email') || lowerQuery.includes('g·ª≠i mail')) { action = "G·ª≠i b·∫£n nh√°p qua email cho Ph√≤ng ban li√™n quan ƒë·ªÉ l·∫•y √Ω ki·∫øn"; } 
            else if (lowerQuery.includes('chia s·∫ª')) { action = "L∆∞u tr·ªØ tr√™n Docs v√† chia s·∫ª ngay v·ªõi ng∆∞·ªùi y√™u c·∫ßu"; } 
            else if (lowerQuery.includes('l∆∞u tr·ªØ') && lowerQuery.includes('chia s·∫ª')) { action = "L∆∞u tr·ªØ v√† chia s·∫ª ngay l·∫≠p t·ª©c theo y√™u c·∫ßu ƒë√£ n√™u"; }
            
            if (action === "ki·ªÉm tra l·∫°i n·ªôi dung" && query.length > 30) { action = "ki·ªÉm tra l·∫°i n·ªôi dung tr∆∞·ªõc khi ban h√†nh"; }
            
            return action;
        }


        function renderTthcList() {
            const listContainer = document.getElementById('tthc-list');
            listContainer.innerHTML = tthcData.map((item) => `
                <button 
                    data-tthc-name="${item.tenThuTuc}"
                    class="tthc-button text-xs py-2 px-3 rounded-lg transition duration-150 ease-in-out border"
                    onclick="selectTthc('${item.tenThuTuc.replace(/'/g, "\\'")}')"
                >
                    ${item.tenThuTuc}
                </button>
            `).join('');
        }

        function selectTthc(tthcName) {
            selectedTthc = tthcName;
            
            document.querySelectorAll('.tthc-button').forEach(btn => {
                if (btn.getAttribute('data-tthc-name') === tthcName) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            updateDisplayTitle(); 
        }

        function selectAction(actionName) {
            selectedAction = actionName;
            document.querySelectorAll('.func-button').forEach(btn => {
                if (btn.getAttribute('data-action') === actionName) {
                    btn.classList.add('selected');
                    btn.style.borderColor = btn.style.backgroundColor;
                } else {
                    btn.classList.remove('selected');
                    btn.style.borderColor = '#e5e7eb'; 
                }
            });
            updateDisplayTitle();
        }
        
        function updateDisplayTitle() {
            const tthcDisplay = selectedTthc ? `${selectedTthc}` : `[Ch∆∞a ch·ªçn TTHC]`;
            const actionDisplay = selectedAction ? ` | H√†nh ƒë·ªông: ${selectedAction}` : ``;
            document.getElementById('selected-tthc-name').innerHTML = `<span class="text-blue-600 font-extrabold">${tthcDisplay}</span>${actionDisplay}`;
        }


        /**
         * H√†m Ph√¢n lo·∫°i y√™u c·∫ßu ng∆∞·ªùi d√πng v√† Sinh Prompt T·ªëi ∆Øu
         */
        async function generateOptimizedPrompt() {
            const yeuCauGoc = document.getElementById('user-query-input').value.trim();
            const resultContainer = document.getElementById('generated-prompt-output');
            const copyButton = document.getElementById('copy-button');
            const button = document.getElementById('execute-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');

            // --- KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN T·ªêI THI·ªÇU ---
            const minConditionMet = selectedAction || selectedTthc || yeuCauGoc;
            
            if (!minConditionMet) {
                resultContainer.innerHTML = '<p class="text-center text-red-600 italic">‚ö†Ô∏è Vui l√≤ng cung c·∫•p √≠t nh·∫•t m·ªôt ƒë·∫ßu v√†o (TTHC, H√†nh ƒë·ªông, ho·∫∑c Y√™u c·∫ßu) ƒë·ªÉ x√¢y d·ª±ng c√¢u l·ªánh!</p>';
                copyButton.classList.add('hidden');
                return;
            }

            // T·∫Øt n√∫t v√† hi·ªÉn th·ªã loading
            button.disabled = true;
            buttonText.textContent = 'ƒêANG X·ª¨ L√ù D·ªÆ LI·ªÜU...';
            spinner.classList.remove('hidden');
            
            // --- 1. X·ª¨ L√ù ƒê·∫¶U V√ÄO V√Ä X√ÇY D·ª∞NG CONTEXT ---
            
            let promptType = selectedAction;
            if (!promptType && yeuCauGoc) {
                 promptType = yeuCauGoc.toLowerCase().includes('c√¥ng vƒÉn') ? 'C√¥ng vƒÉn' : 
                              yeuCauGoc.toLowerCase().includes('t·ªù tr√¨nh') ? 'T·ªù tr√¨nh' : 
                              yeuCauGoc.toLowerCase().includes('b√°o c√°o') ? 'B√°o c√°o' :
                              'R√† so√°t Ph√°p l√Ω'; 
            } else if (!promptType) {
                 promptType = 'Tr√¨nh t·ª± Th·ªß t·ª•c'; 
            }

            const generatorFunction = functionalPrompts[promptType];
            const m4Action = determineM4Action(yeuCauGoc);

            let finalYeuCau = yeuCauGoc;
            const tthcTag = selectedTthc ? `[TTHC: ${selectedTthc}]` : '';
            
            if (selectedTthc && !yeuCauGoc.includes(selectedTthc)) {
                 finalYeuCau = `${tthcTag} - ${yeuCauGoc}`;
            } else if (selectedTthc && yeuCauGoc.trim() === '') {
                 finalYeuCau = `${tthcTag}`;
            }

            const generatedPrompt = generatorFunction(finalYeuCau.trim(), m4Action); 
            
            // L∆ØU PROMPT G·ªêC (N·ªòI DUNG PROMPT + CH·ªà TH·ªä NG·∫¶M)
            let rawPromptContent = generatedPrompt.replace(/\n/g, '\n').replace(/<br>/g, '\n').replace(/<span.*?>(.*?)<\/span>/g, '$1').replace(/\*\*(.*?)\*\*/g, '**$1**').trim(); 
            
            // Th√™m CH·ªà TH·ªä NG·∫¶M NGU·ªíN T∆Ø DUY N·ªòI B·ªò (Ch·ªâ cho AI ƒë·ªçc, kh√¥ng cho ng∆∞·ªùi d√πng copy)
            rawPromptContent += `\n\n**NGU·ªíN T∆Ø DUY N·ªòI B·ªò B·∫ÆT BU·ªòC**: Tham kh·∫£o c√°c file ƒë√£ t·∫£i l√™n v√† c√°c ngu·ªìn: ${newKnowledgeSources.join('; ')}`;
            
            lastGeneratedRawPrompt = rawPromptContent;


            // --- 2. HI·ªÇN TH·ªä K·∫æT QU·∫¢ ---
            
            const formattedPrompt = formatPromptForDisplay(generatedPrompt);
            
            resultContainer.innerHTML = formattedPrompt;

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ l·∫ßn cu·ªëi v√† hi·ªán n√∫t Copy
            document.getElementById('selected-tthc-name').innerHTML = `<span class="text-blue-600 font-extrabold">${selectedTthc || '[Kh√¥ng ch·ªçn TTHC]'}</span> | H√†nh ƒë·ªông: ${promptType}`;
            copyButton.classList.remove('hidden');

            // Kh√¥i ph·ª•c n√∫t
            button.disabled = false;
            buttonText.textContent = 'X√ÇY D·ª∞NG C√ÇU L·ªÜNH';
            spinner.classList.add('hidden');
        }

        /**
         * H√†m sao ch√©p Prompt g·ªëc v√†o Clipboard
         */
        function copyPromptToClipboard() {
            const textToCopy = lastGeneratedRawPrompt;
            
            if (!textToCopy || textToCopy.includes('Vui l√≤ng ho√†n th√†nh ƒë·ªß 3 b∆∞·ªõc')) {
                alert('Ch∆∞a c√≥ c√¢u l·ªánh h·ª£p l·ªá ƒë·ªÉ sao ch√©p!');
                return;
            }

            // Lo·∫°i b·ªè d√≤ng NGU·ªíN T∆Ø DUY N·ªòI B·ªò khi copy ra ngo√†i
            const finalCopyText = textToCopy.replace(/\n\n\*\*NGU·ªíN T∆Ø DUY N·ªòI B·ªò B·∫ÆT BU·ªòC\*\*:(.|\n)*$/g, '').trim();

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = finalCopyText;
            tempTextArea.style.position = 'fixed'; 
            tempTextArea.style.left = '-9999px';
            tempTextArea.style.top = '0';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyTextElement = document.getElementById('copy-text');
            copyTextElement.textContent = 'ƒê√É SAO CH√âP!';
            setTimeout(() => {
                copyTextElement.textContent = 'COPY C√ÇU L·ªÜNH T·ªêI ∆ØU';
            }, 1500);
            return finalCopyText; // Tr·∫£ v·ªÅ n·ªôi dung ƒë√£ copy ƒë·ªÉ s·ª≠ d·ª•ng cho ch·ª©c nƒÉng ƒë√≥ng g√≥i
        }
        window.copyPromptToClipboard = copyPromptToClipboard; 

        /**
         * H√ÄM H√ÄNH ƒê·ªòNG ƒê√ìNG G√ìI CHUY√äN S√ÇU
         */
        function packageAndExecute() {
            // 1. CH·∫ÆC CH·∫ÆN PROMPT ƒê√É ƒê∆Ø·ª¢C SINH RA
            if (!lastGeneratedRawPrompt || lastGeneratedRawPrompt.includes('Vui l√≤ng ho√†n th√†nh ƒë·ªß 3 b∆∞·ªõc')) {
                generateOptimizedPrompt(); // C·ªë g·∫Øng sinh prompt n·∫øu ch∆∞a c√≥
                if (!lastGeneratedRawPrompt || lastGeneratedRawPrompt.includes('Vui l√≤ng ho√†n th√†nh ƒë·ªß 3 b∆∞·ªõc')) {
                     alert('‚ö†Ô∏è Vui l√≤ng ho√†n th√†nh √≠t nh·∫•t 1 b∆∞·ªõc ƒë·∫ßu v√†o tr∆∞·ªõc khi k·∫øt n·ªëi MINI AI.');
                     return;
                }
            }

            // 2. T·ª∞ ƒê·ªòNG COPY L·ªÜNH T·ªêI ∆ØU (ƒë√£ lo·∫°i b·ªè ch·ªâ th·ªã ng·∫ßm)
            const copiedPrompt = copyPromptToClipboard();

            // 3. M·ªû NOTEBOOKLM V√Ä Y√äU C·∫¶U TH·ª∞C THI (th√¥ng b√°o h∆∞·ªõng d·∫´n)
            window.open(NOTEBOOK_URL, '_blank');
            
            // 4. TH√îNG B√ÅO TH·ª∞C THI CHUY√äN NGHI·ªÜP
            alert(`‚úÖ ƒê√É SAO CH√âP C√ÇU L·ªÜNH T·ªêI ∆ØU TH√ÄNH C√îNG!\n\nMINI AI ƒë√£ m·ªü NotebookLM c·ªßa Anh ƒê·ª©c Anh (Link: ${NOTEBOOK_URL}).\n\nB∆∞·ªõc cu·ªëi c√πng: Vui l√≤ng chuy·ªÉn sang tab NotebookLM v·ª´a m·ªü v√† **D√ÅN (Ctrl+V)** c√¢u l·ªánh v√†o Chatbox ƒë·ªÉ AI th·ª±c thi ngay l·∫≠p t·ª©c.`);
        }
        window.packageAndExecute = packageAndExecute;


        // H√†m b√¥i ƒëen n·ªôi dung khi click v√†o khung k·∫øt qu·∫£
        function selectText(containerid) {
            const container = document.getElementById(containerid);
            if (!container || !lastGeneratedRawPrompt) return; 

            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(container);
            selection.removeAllRanges();
            selection.addRange(range);
        }
        window.selectText = selectText;


        // ƒê·ªãnh d·∫°ng Prompt ƒë·∫ßu ra ƒë·ªÉ hi·ªÉn th·ªã m√†u s·∫Øc v√† xu·ªëng d√≤ng trong HTML
        function formatPromptForDisplay(promptText) {
            let htmlContent = promptText.replace(/\n/g, '<br>');

            const tags = ['#(VAI TR√í)', '#(Y√äU C·∫¶U)', '#(C√ÅC B∆Ø·ªöC)', '#(M·ª§C TI√äU CU·ªêI C√ôNG)', '#(GI·ªöI H·∫†N & R√ÄNG BU·ªòC)'];
            tags.forEach(tag => {
                const regex = new RegExp(tag.replace('(', '\\(').replace(')', '\\)'), 'g');
                htmlContent = htmlContent.replace(regex, `<span class="text-blue-600 font-bold">${tag}</span>`); 
            });

            htmlContent = htmlContent.replace(/\[(.*?)\]/g, (match, p1) => 
                `<span class="text-red-500 font-bold">[${p1}]</span>`
            );
            
            htmlContent = htmlContent.replace(/Ngh·ªã ƒë·ªãnh 30\/2020\/Nƒê-CP/g, `<span class="text-green-600 font-bold">Ngh·ªã ƒë·ªãnh 30/2020/Nƒê-CP</span>`);
            htmlContent = htmlContent.replace(/Lu·∫≠t ƒê·∫•t ƒëai 2024/g, `<span class="text-green-600 font-bold">Lu·∫≠t ƒê·∫•t ƒëai 2024</span>`);
            htmlContent = htmlContent.replace(/VƒÇN B·∫¢N H·ª¢P NH·∫§T Nƒê 151 v√† Nƒê 226\/2025\/Nƒê-CP/g, `<span class="text-purple-600 font-extrabold">VƒÇN B·∫¢N H·ª¢P NH·∫§T Nƒê 151 v√† Nƒê 226/2025/Nƒê-CP</span>`);
            htmlContent = htmlContent.replace(/B·∫Øt bu·ªôc th·ª±c hi·ªán (.*?) sau khi so·∫°n th·∫£o./g, (match) => 
                `<span class="text-orange-600 font-bold">${match}</span>`
            ); 

            return htmlContent;
        }
        
        // Logic hi·ªÉn th·ªã Sticky Header
        window.onscroll = function() {
            const stickyHeader = document.getElementById('sticky-header');
            if (window.scrollY > 150) { 
                stickyHeader.classList.remove('hidden');
                stickyHeader.style.opacity = '1';
            } else {
                stickyHeader.style.opacity = '0';
                setTimeout(() => { stickyHeader.classList.add('hidden'); }, 300);
            }
        };

        // ----------------------------------------------------------------------
        // KH·ªûI T·∫†O
        // ----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            if (Object.keys(firebaseConfig).length > 0) {
                 initializeFirebase();
            } else {
                 console.log("S·ª≠ d·ª•ng ch·∫ø ƒë·ªô ch·∫°y c·ª•c b·ªô (local). B·ªè qua k·∫øt n·ªëi Firebase.");
                 document.getElementById('data-status').textContent = '‚ö†Ô∏è ƒêang ch·∫°y ·ªü ch·∫ø ƒë·ªô c·ª•c b·ªô. Danh m·ª•c TTHC l√† d·ªØ li·ªáu m·∫´u.';
                 useStaticDataFallback();
            }
            document.getElementById('execute-button').addEventListener('click', generateOptimizedPrompt);
        });
    </script>
</body>
</html>
